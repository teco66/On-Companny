<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finalizar Pedido ‚Ä¢ On Company</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(180deg,#fdf9f4,#f5efe8);
  color:#333;
}
.container{
  max-width:760px;
  margin:40px auto;
  background:#fff;
  border-radius:18px;
  padding:24px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
h1{text-align:center;margin-top:0}
.section{margin-bottom:30px}
.section h2{font-size:18px;margin-bottom:12px}

.resumo{
  background:#faf7f2;
  padding:16px;
  border-radius:12px;
  font-size:14px;
}

.pagamento{
  background:#f0f7f4;
  border:1px solid #cfe7dd;
  padding:16px;
  border-radius:12px;
  font-size:14px;
}
.pagamento .linha{
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin:6px 0;
  align-items:center;
}
.pagamento code{
  background:#fff;
  padding:6px 8px;
  border-radius:6px;
  font-size:13px;
}
.copy-btn{
  padding:6px 10px;
  border:none;
  border-radius:8px;
  background:#cbb69c;
  color:#fff;
  cursor:pointer;
  font-size:12px;
}

label{display:block;font-size:14px;margin-bottom:6px}
input{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc}

button.enviar,button.voltar{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  background:#cbb69c;
  color:#fff;
  font-size:16px;
  cursor:pointer;
}
button.enviar:disabled{background:#aaa}
button.voltar{margin-top:10px;font-size:14px}
</style>
</head>

<body>

<div class="container">

<h1>Finalize seu pedido</h1>

<div class="section">
  <h2>üì¶ Resumo do pedido</h2>
  <div class="resumo" id="resumoPedido">Carregando...</div>
</div>

<div class="section">
  <h2>üë§ Dados do cliente</h2>
  <label>Nome *</label>
  <input id="nome">
  <label>WhatsApp *</label>
  <input id="whatsapp">
  <label>Cidade *</label>
  <input id="cidade">
</div>

<div class="section">
  <h2>üìé Comprovante *</h2>
  <div style="position:relative">
    <input type="file" id="comprovante">
    <button id="removeFile" type="button"
      style="display:none;position:absolute;right:10px;top:8px;
      border:none;background:#ff4d4d;color:#fff;border-radius:50%;
      width:22px;height:22px;cursor:pointer">√ó</button>
  </div>
</div>

<button class="enviar" id="btnEnviar" disabled>Enviar pedido</button>
<button class="voltar" onclick="location.href='index.html'">‚Üê Voltar</button>

</div>

<script>
// ================== RESUMO ==================
const resumoDiv = document.getElementById("resumoPedido");
let cart = {};

try {
  cart = JSON.parse(localStorage.getItem("cart")) || {};
} catch {}

if (!Object.keys(cart).length) {
  resumoDiv.innerHTML = "Carrinho vazio.";
} else {
  let subtotal = 0;
  let html = "<ul>";
  Object.values(cart).forEach(i=>{
    subtotal += i.price * i.qty;
    html += `<li>${i.name} (${i.qty}x)</li>`;
  });
  const rate = subtotal >= 150000 ? 0.10 : 0.15;
  html += `</ul>
    <p><strong>Subtotal:</strong> ${subtotal.toLocaleString("pt-BR")} Kz</p>
    <p><strong>Taxa:</strong> ${(subtotal*rate).toLocaleString("pt-BR")} Kz</p>
    <p><strong>Total:</strong> ${(subtotal*(1+rate)).toLocaleString("pt-BR")} Kz</p>`;
  resumoDiv.innerHTML = html;
}

// ================== VALIDA√á√ÉO ==================
const fileInput = document.getElementById("comprovante");
const removeBtn = document.getElementById("removeFile");
const btnEnviar = document.getElementById("btnEnviar");

function validar(){
  btnEnviar.disabled = !(
    nome.value.trim() &&
    whatsapp.value.trim() &&
    cidade.value.trim() &&
    fileInput.files.length
  );
}

["nome","whatsapp","cidade"].forEach(id=>{
  document.getElementById(id).addEventListener("input", validar);
});

fileInput.onchange = ()=>{
  if(fileInput.files.length) removeBtn.style.display="block";
  validar();
};

removeBtn.onclick = ()=>{
  fileInput.value="";
  removeBtn.style.display="none";
  btnEnviar.disabled=true;
};

// ================== ENVIO ==================
btnEnviar.onclick = ()=>{
  const file = fileInput.files[0];
  let subtotal = 0;
  const itens = Object.values(cart).map(i=>{
    subtotal += i.price * i.qty;
    return `${i.id}:${i.qty}`;
  }).join(" | ");

  const reader = new FileReader();
  reader.onload = async ()=>{
    const payload = {
      nome: nome.value,
      whatsapp: whatsapp.value,
      cidade: cidade.value,
      itens,
      subtotal,
      file: reader.result.split(",")[1],
      fileName: file.name,
      fileType: file.type
    };

    const resp = await fetch("SEU_LINK_DO_APPS_SCRIPT",{
      method:"POST",
      body:new URLSearchParams({ data: JSON.stringify(payload) })
    });

    const result = JSON.parse(await resp.text());
    if(result.status==="ok"){
      localStorage.removeItem("cart");
      location.href="sucesso.html";
    }else{
      alert(result.msg || "Erro no servidor");
    }
  };
  reader.readAsDataURL(file);
};
</script>

</body>
</html>

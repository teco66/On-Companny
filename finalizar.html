<script>
/* =========================
   RESUMO DO PEDIDO
========================= */
const resumoDiv = document.getElementById("resumoPedido");

let cart = {};
try {
  cart = JSON.parse(localStorage.getItem("cart")) || {};
} catch {
  cart = {};
}

if (!Object.keys(cart).length) {
  resumoDiv.innerHTML = "Nenhum produto encontrado no carrinho.";
} else {
  let subtotal = 0;
  let html = "<ul>";

  Object.values(cart).forEach(item => {
    subtotal += item.price * item.qty;
    html += `<li>${item.name} (${item.qty}x)</li>`;
  });

  const rate = subtotal >= 150000 ? 0.10 : 0.15;
  const tax = subtotal * rate;
  const total = subtotal + tax;

  html += "</ul>";
  html += `<p><strong>Subtotal:</strong> ${subtotal.toLocaleString("pt-BR")} Kz</p>`;
  html += `<p><strong>Taxa (${rate * 100}%):</strong> ${tax.toLocaleString("pt-BR")} Kz</p>`;
  html += `<p><strong>Total a pagar:</strong> ${total.toLocaleString("pt-BR")} Kz</p>`;

  resumoDiv.innerHTML = html;
}

/* =========================
   ELEMENTOS
========================= */
const nome = document.getElementById("nome");
const whatsapp = document.getElementById("whatsapp");
const cidade = document.getElementById("cidade");
const fileInput = document.getElementById("comprovante");
const removeBtn = document.getElementById("removeFile");
const btnEnviar = document.getElementById("btnEnviar");

/* =========================
   VALIDAÇÃO
========================= */
function validarFormulario() {
  const ok =
    nome.value.trim() &&
    whatsapp.value.trim() &&
    cidade.value.trim() &&
    fileInput.files.length;

  btnEnviar.disabled = !ok;
}

[nome, whatsapp, cidade].forEach(el => {
  el.addEventListener("input", validarFormulario);
});

fileInput.onchange = () => {
  if (fileInput.files.length) {
    removeBtn.style.display = "block";
  }
  validarFormulario();
};

removeBtn.onclick = () => {
  fileInput.value = "";
  removeBtn.style.display = "none";
  btnEnviar.disabled = true;
};

/* =========================
   ENVIO PARA APPS SCRIPT
========================= */
btnEnviar.onclick = async () => {
  let subtotal = 0;

  const itens = Object.values(cart).map(i => {
    subtotal += i.price * i.qty;
    return `${i.id}:${i.qty}`;
  }).join(" | ");

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = async () => {
    const payload = {
      nome: nome.value.trim(),
      whatsapp: whatsapp.value.trim(),
      cidade: cidade.value.trim(),
      itens,
      subtotal,
      file: reader.result.split(",")[1],
      fileName: file.name,
      fileType: file.type
    };

    try {
      const resp = await fetch("SEU_LINK_DO_APPS_SCRIPT", {
        method: "POST",
        body: new URLSearchParams({
          data: JSON.stringify(payload)
        })
      });

      const result = JSON.parse(await resp.text());

      if (result.status === "ok") {
        localStorage.removeItem("cart");
        window.location.href = "sucesso.html";
      } else {
        alert("Erro no servidor:\n" + (result.msg || "sem mensagem"));
      }

    } catch (err) {
      alert("Falha na comunicação com o servidor.");
    }
  };

  reader.readAsDataURL(file);
};
</script>
